<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Memory 05 ¬∑ The Commitment ¬∑ Premium red & beige</title>
    <style>
        /* =====================================================
           PREMIUM RED & BEIGE THEME ‚Äî GOLD ACCENTS, VELVET MOOD
        ===================================================== */
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Dancing+Script:wght@400;700&family=Poppins:wght@300;400;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --deep-red: #6b0f1a;
            --wine: #8b1e3f;
            --brick: #b23e3e;
            --beige-soft: #f9e6cf;
            --beige-cream: #f3ddc1;
            --gold: #d4af37;
            --old-gold: #c5a028;
            --shadow-velvet: rgba(40, 10, 20, 0.5);
            --glow-warm: rgba(255, 215, 140, 0.6);
        }

        body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            font-family: 'Poppins', sans-serif;
            background: radial-gradient(circle at 30% 40%, #a53f3f, #561c1c 80%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            color: white;
            opacity: 0;
            transition: opacity 1.8s cubic-bezier(0.25, 0.1, 0.15, 1);
            position: relative;
            box-shadow: inset 0 0 150px rgba(0,0,0,0.6);
        }

        body.loaded {
            opacity: 1;
        }

        /* velvet vignette + premium grain */
        body::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at 50% 70%, transparent 30%, rgba(90, 30, 20, 0.4) 90%);
            pointer-events: none;
            z-index: 5;
            mix-blend-mode: multiply;
        }

        /* Ambient gold dust hearts */
        .ambient-hearts {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .bg-heart {
            position: absolute;
            color: rgba(212, 175, 55, 0.15);
            font-size: 24px;
            animation: floatUp 20s linear infinite;
            filter: drop-shadow(0 0 5px #ffd966);
        }

        @keyframes floatUp {
            0% { transform: translateY(100vh) rotate(0deg) scale(0.8); opacity: 0; }
            20% { opacity: 0.6; }
            100% { transform: translateY(-15vh) rotate(360deg) scale(1.5); opacity: 0; }
        }

        /* =====================================================
           SCENERY ‚Äî BRIDGE, RIVER, TRAIN (premium textures)
        ===================================================== */
        .scenery-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .track-container {
            position: absolute;
            bottom: 25vh;
            width: 120%;
            left: -10%;
            height: 20px;
            border-bottom: 4px solid #4a2c1a;
            background: repeating-linear-gradient(90deg, transparent 0 18px, #8b5a2b 18px 24px);
            opacity: 0;
            transition: opacity 1s;
            z-index: 2;
            box-shadow: 0 2px 8px #2f1d0e;
        }

        .train-group {
            position: absolute;
            bottom: 26vh;
            right: -100vw;
            display: flex;
            align-items: center;
            flex-direction: row-reverse;
            transition: right 0.05s linear;
            z-index: 3;
            filter: drop-shadow(0 15px 15px rgba(0,0,0,0.5));
        }

        .train-emoji {
            font-size: 5rem;
            transform: scaleX(-1);
            text-shadow: 2px 5px 10px #2f1a0e;
        }

        .him-arrival {
            position: relative;
            right: -20px;
            bottom: 10px;
            width: 80px;
            height: auto;
            filter: drop-shadow(0 8px 8px black);
        }

        /* bridge with stone texture */
        .bridge-structure {
            position: absolute;
            bottom: 20vh;
            width: 100%;
            height: 120px;
            opacity: 0;
            transition: opacity 2s;
            z-index: 2;
        }

        .bridge-arch {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #7b5f44 0%, #9b7e5e 100%);
            border-bottom: 6px solid #4f3a28;
            border-radius: 50% 50% 0 0 / 100% 100% 0 0;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
            opacity: 0.9;
        }

        .bridge-arch::after {
            content: "";
            position: absolute;
            top: 20px;
            width: 100%;
            height: 40px;
            background: repeating-linear-gradient(90deg, #3f2e1e 0px, #3f2e1e 4px, #b89a70 4px, #b89a70 12px);
            opacity: 0.4;
        }

        .river {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 22vh;
            background: linear-gradient(180deg, #471e1e, #2f0f0f);
            z-index: 1;
            opacity: 0;
            transition: opacity 2s;
            box-shadow: inset 0 10px 20px #1a0808;
        }

        .ripple {
            position: absolute;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(90deg, transparent 0px, transparent 60px, rgba(212, 175, 55, 0.15) 65px, transparent 75px);
            animation: flow 9s linear infinite;
        }

        @keyframes flow {
            0% { background-position: 0 0; }
            100% { background-position: 300px 0; }
        }

        /* =====================================================
           ACTORS ‚Äî premium glow + gold outlines
        ===================================================== */
        .stage {
            position: absolute;
            bottom: 16vh;
            width: 100%;
            height: 240px;
            z-index: 10;
            pointer-events: none;
        }

        .avatar {
            position: absolute;
            bottom: 0;
            transition: all 1.2s cubic-bezier(0.34, 1.2, 0.64, 1);
            filter: drop-shadow(0 12px 15px rgba(0,0,0,0.6)) drop-shadow(0 0 8px var(--gold));
            object-fit: contain;
            image-rendering: crisp-edges;
            border-radius: 30px 30px 20px 20px;
        }

        #her {
            left: 28%;
            height: 110px;
            z-index: 12;
            opacity: 0;
        }

        #him {
            right: 28%;
            height: 120px;
            z-index: 11;
            opacity: 0;
            left: auto;
        }

        /* closeness classes ‚Äî refined */
        .closer #her { left: 38%; }
        .closer #him { right: 38%; }

        .intimate #her {
            left: 44%;
            transform: rotate(5deg) scale(1.02);
            filter: drop-shadow(0 0 18px #ffb3b3);
        }
        .intimate #him {
            right: 42%;
            transform: rotate(-5deg) scale(1.02);
            filter: drop-shadow(0 0 18px #ffb3b3);
        }

        /* final together position (side by side, facing each other softly) */
        .together-final #her {
            left: 32%;
            transform: scale(1.05) rotate(2deg);
            filter: drop-shadow(0 0 25px #f9d78c);
            z-index: 15;
        }
        .together-final #him {
            left: 52%;
            transform: scale(1.08) rotate(-2deg);
            filter: drop-shadow(0 0 25px #f9d78c);
            z-index: 15;
        }

        /* =====================================================
           UI / TEXT ‚Äî luxurious beige & gold
        ===================================================== */
        .ui-layer {
            position: absolute;
            top: 8%;
            width: 90%;
            max-width: 460px;
            text-align: center;
            z-index: 100;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .story-text {
            display: inline-block;
            background: rgba(250, 240, 220, 0.95);
            color: #661c32;
            padding: 18px 34px;
            border-radius: 60px;
            font-family: 'Dancing Script', cursive;
            font-size: 1.7rem;
            font-weight: 700;
            box-shadow: 0 15px 30px rgba(100, 30, 20, 0.4), 0 0 0 2px #d4af37 inset;
            border: 1px solid #ffe5aa;
            backdrop-filter: blur(2px);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.8s ease;
            line-height: 1.3;
        }

        .story-text.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .instruction {
            margin-top: 18px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 400;
            color: #faead3;
            text-shadow: 0 3px 8px #4d1e1e;
            background: rgba(155, 55, 55, 0.7);
            padding: 8px 24px;
            border-radius: 40px;
            backdrop-filter: blur(4px);
            border: 1px solid #f5cba0;
            letter-spacing: 0.5px;
            opacity: 0;
            transition: opacity 0.5s;
            display: inline-block;
            box-shadow: 0 5px 15px black;
        }

        .instruction.visible { opacity: 1; }

        /* =====================================================
           INTERACTIONS ‚Äî chocolate, hold ring, drag
        ===================================================== */
        .drive-btn {
            position: absolute;
            bottom: 12vh;
            pointer-events: auto;
            width: 85px;
            height: 85px;
            background: radial-gradient(circle, #fbe9d2, #e6c99c);
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 2.6rem;
            box-shadow: 0 0 40px #f7d970, 0 10px 20px #3e1a1a;
            border: 3px solid #b37b48;
            cursor: pointer;
            transition: all 0.15s;
            z-index: 50;
        }
        .drive-btn:active { transform: scale(0.86); background: #f5d799; }

        .chocolate {
            position: absolute;
            font-size: 4.2rem;
            bottom: 28vh;
            right: 30%;
            filter: drop-shadow(0 0 22px #f1cf7a);
            cursor: pointer;
            animation: float 2.4s infinite ease-in-out;
            pointer-events: auto;
            opacity: 0;
            z-index: 30;
            transition: all 0.7s;
            text-shadow: 0 5px 10px #301010;
        }

        .hold-ring {
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 140px;
            height: 140px;
            border: 3px solid rgba(255, 235, 190, 0.7);
            border-radius: 50%;
            display: none;
            pointer-events: auto;
            cursor: pointer;
            box-shadow: 0 0 40px #ffb6b6, inset 0 0 20px #f7c56e;
            backdrop-filter: blur(2px);
        }

        .hold-fill {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #ff99aa, #ff4d6d);
            border-radius: 50%;
            transform: scale(0);
            transition: transform 0.08s linear;
            opacity: 0.7;
        }

        .word-container {
            position: absolute;
            top: 45%;
            width: 100%;
            display: none;
            justify-content: center;
            gap: 60px;
            pointer-events: none;
            z-index: 60;
        }

        .word-target {
            border: 2px dashed #fbe4b0;
            border-radius: 30px;
            width: 150px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff6e5;
            font-weight: 600;
            font-size: 1.3rem;
            background: rgba(80, 25, 25, 0.5);
            backdrop-filter: blur(4px);
            box-shadow: 0 0 15px gold;
        }

        #drag-word {
            position: absolute;
            pointer-events: auto;
            cursor: grab;
            z-index: 200;
            background: #e4c37d;
            color: #3d2020;
            padding: 12px 28px;
            border-radius: 40px;
            font-weight: bold;
            font-size: 1.4rem;
            box-shadow: 0 15px 25px #392020;
            border: 2px solid #fcedb3;
            transform: translate(-50%, 0);
        }

        /* treasure */
        .hidden-heart {
            position: absolute;
            bottom: 9vh;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2.8rem;
            opacity: 0;
            cursor: pointer;
            filter: drop-shadow(0 0 30px #ffb347);
            animation: pulse 1.9s infinite;
            pointer-events: none;
            z-index: 200;
            transition: opacity 1s;
            text-shadow: 0 5px 10px #4f2020;
        }

        @keyframes pulse {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.2); filter: drop-shadow(0 0 40px #ffdb8e); }
        }

        /* treasure modal ‚Äî velvet & gold */
        .treasure-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(58, 15, 15, 0.97);
            z-index: 300;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1.2s;
            backdrop-filter: blur(5px);
        }

        .treasure-box {
    font-size: clamp(4rem, 8vw, 7rem);
    cursor: pointer;
    transition: transform 0.7s ease;
    filter: drop-shadow(0 0 50px #ffd966);
    display: flex;
    justify-content: center;
    align-items: center;
}


        .note-paper {
            background: #fff2df;
            color: #721c3a;
            width: 85%;
            max-width: 400px;
            padding: 45px 30px;
            font-family: 'Dancing Script', cursive;
            font-size: 1.8rem;
            box-shadow: 0 0 80px #d49b6a, 0 20px 30px #1f0707;
            transform: scale(0);
            transition: transform 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-align: center;
            border-radius: 30px;
            border: 4px solid #cbaa76;
            line-height: 1.8;
        }

        .note-line { opacity: 0; transition: opacity 1.2s; display: block; margin-bottom: 18px; }

        .premium-btn {
            margin-top: 35px;
            padding: 16px 44px;
            background: linear-gradient(145deg, #c98f4a, #aa6e3a);
            color: white;
            border: none;
            border-radius: 50px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            cursor: pointer;
            opacity: 0;
            transition: opacity 1s, transform 0.2s;
            box-shadow: 0 20px 30px #2e0e0e;
            border: 1px solid #f3cf94;
            font-size: 1.2rem;
        }
        .premium-btn:hover { transform: scale(1.06); background: #dba15a; }

        /* floating particles */
        .particle {
            position: absolute;
            font-size: 2rem;
            animation: rise 2.4s forwards;
            pointer-events: none;
            z-index: 999;
            filter: drop-shadow(0 0 10px currentColor);
        }
        @keyframes rise {
            to { transform: translateY(-200px) scale(1.8); opacity: 0; }
        }

        @keyframes float {
            0% { transform: translateY(0); }
            50% { transform: translateY(-13px); }
        }

        /* responsive */
        @media (max-width: 600px) {
            .train-emoji { font-size: 3.5rem; }
            .him-arrival { width: 60px; right: -15px; }
            #her { height: 95px; }
            #him { height: 105px; }
            .story-text { font-size: 1.4rem; padding: 12px 20px; }
            .together-final #her { left: 28%; }
            .together-final #him { left: 55%; }
        }
        /* ===============================
   RESPONSIVE FIXES
================================= */

/* Large Screens */
@media (min-width: 1000px) {

    body {
        justify-content: center;
    }

    .stage {
        bottom: 12vh;
        height: 280px;
    }

    #her {
        height: 140px;
    }

    #him {
        height: 150px;
    }

    .story-text {
        font-size: 2rem;
        max-width: 600px;
    }

    .instruction {
        font-size: 1.1rem;
    }

    .bridge-structure {
        height: 150px;
    }

    .river {
        height: 18vh;
    }

}

/* Small Phones */
@media (max-width: 480px) {

    .stage {
        height: 200px;
    }

    #her {
        height: 85px;
    }

    #him {
        height: 95px;
    }

    .story-text {
        font-size: 1.2rem;
        padding: 12px 16px;
    }

    .instruction {
        font-size: 0.85rem;
        padding: 6px 14px;
    }

    .hold-ring {
        width: 110px;
        height: 110px;
    }

    .drive-btn {
        width: 70px;
        height: 70px;
        font-size: 2rem;
    }
}

    </style>
</head>
<body>
    <div class="ambient-hearts" id="ambient-bg"></div>

    <div class="scenery-layer">
        <div class="track-container" id="track"></div>
        <div class="train-group" id="train-group">
            <div class="train-emoji">üöÜ</div>
            <img src="assets/comh.png" class="him-arrival" alt="Him Arriving">
        </div>

        <div class="bridge-structure" id="bridge">
            <div class="bridge-arch"></div>
        </div>
        <div class="river" id="river">
            <div class="ripple"></div>
            <div class="hidden-heart" id="treasure-trigger">üíñ</div>
        </div>
    </div>

    <div class="stage" id="stage">
        <img src="assets/com.png" id="her" class="avatar" alt="Her">
        <img src="assets/comh.png" id="him" class="avatar" alt="Him">
    </div>

    <div class="ui-layer">
        <div class="story-text" id="story"></div>
        <div class="instruction" id="instr"></div>
    </div>

    <div class="drive-btn" id="drive-btn">üöÇ</div>
    <div class="chocolate" id="choco">üç´</div>
    <div class="hold-ring" id="hold-btn"><div class="hold-fill" id="hold-fill"></div></div>

    <div class="word-container" id="word-game">
        <div class="word-target" id="drop-zone">We are...</div>
    </div>
    <div id="drag-word" style="display:none;">Forever</div>

    <div class="treasure-modal" id="modal">
        <div class="treasure-box" id="box" onclick="revealNote()">üéÅ</div>
        <div class="note-paper" id="note">
            <span class="note-line">You are my treasure.</span>
            <span class="note-line">I love being with you.</span>
            <span class="note-line">Thank you for choosing me.</span>
            <span class="note-line">Thank you for staying with me.</span>
            <span class="note-line" style="font-weight:bold; color:#b5455a; margin-top:15px;">Happy Valentine‚Äôs Day ‚ù§Ô∏è</span>
        </div>
        <button class="premium-btn" id="together-btn" onclick="goHome()">üíû Our Forever begins üíû</button>
    </div>

    <script>
        (function() {
            // --- elements ---
            const her = document.getElementById('her');
            const him = document.getElementById('him');
            const story = document.getElementById('story');
            const instr = document.getElementById('instr');
            const track = document.getElementById('track');
            const trainGroup = document.getElementById('train-group');
            const bridge = document.getElementById('bridge');
            const river = document.getElementById('river');
            const driveBtn = document.getElementById('drive-btn');
            const choco = document.getElementById('choco');
            const holdBtn = document.getElementById('hold-btn');
            const holdFill = document.getElementById('hold-fill');
            const wordGame = document.getElementById('word-game');
            const dragWord = document.getElementById('drag-word');
            const dropZone = document.getElementById('drop-zone');
            const treasureTrigger = document.getElementById('treasure-trigger');
            const stage = document.getElementById('stage');
            const modal = document.getElementById('modal');
            const togetherBtn = document.getElementById('together-btn');

            // state
            let phase = 0;
            let trainPos = -100;   // vw (right)
            let driveInterval = null;
            let isHolding = false;
            let trainListenersAttached = false;  // avoid dup
            let phase4DragEnabled = false;
            let finalChocolateShared = false;
window.goHome = function() {
    document.body.style.opacity = 0;   // smooth fade out
    setTimeout(() => {
        window.location.href = "index.html";
    }, 800);
};

            // helpers
            function createAmbientHearts() {
                for (let i = 0; i < 20; i++) {
                    let h = document.createElement('div');
                    h.innerText = "‚ù§Ô∏è";
                    h.className = "bg-heart";
                    h.style.left = Math.random() * 100 + "vw";
                    h.style.fontSize = (Math.random() * 28 + 10) + "px";
                    h.style.animationDuration = (Math.random() * 16 + 12) + "s";
                    h.style.animationDelay = Math.random() * 8 + "s";
                    document.getElementById('ambient-bg').appendChild(h);
                }
            }

            function createParticles(x, y, char) {
                for (let i = 0; i < 16; i++) {
                    let p = document.createElement('div');
                    p.innerText = char;
                    p.className = 'particle';
                    p.style.left = (x + Math.random() * 80 - 40) + 'px';
                    p.style.top = (y + Math.random() * 80 - 40) + 'px';
                    p.style.color = ['#ffd966','#ffb3b3','#f5e5b5'][i%3];
                    document.body.appendChild(p);
                    setTimeout(() => p.remove(), 2000);
                }
            }

            function setPhase(p) {
                phase = p;
                story.classList.remove('visible');
                instr.classList.remove('visible');
                setTimeout(() => runPhase(p), 700);
            }

            // phase logic
            function runPhase(p) {
                story.classList.add('visible');
                if (p === 1) { // train arrival
                    story.innerText = "He came to see me... ";
                    track.style.opacity = 1;
                    setTimeout(() => {
                        story.innerText = "He came by train.";
                        instr.innerText = "The Special Day";
                        instr.classList.add('visible');
                        driveBtn.style.display = "flex";

                        if (!trainListenersAttached) {
                            let moving = false;
                            const startMove = (e) => {
                                e.preventDefault();
                                if (moving) return;
                                moving = true;
                                driveInterval = setInterval(() => {
                                    let currentRight = parseFloat(trainGroup.style.right) || -100;
                                    currentRight += 0.9;
                                    trainGroup.style.right = currentRight + "vw";
                                    if (currentRight >= 18) {
                                        clearInterval(driveInterval);
                                        driveBtn.style.display = "none";
                                        story.innerText = "He arrived.";
                                        moving = false;
                                        setTimeout(() => setPhase(2), 2000);
                                    }
                                }, 20);
                            };
                            const stopMove = () => {
                                clearInterval(driveInterval);
                                moving = false;
                            };
                            driveBtn.addEventListener('mousedown', startMove);
                            driveBtn.addEventListener('touchstart', startMove, { passive: false });
                            window.addEventListener('mouseup', stopMove);
                            window.addEventListener('touchend', stopMove);
                            trainListenersAttached = true;
                        }
                    }, 2000);
                }
                else if (p === 2) { // Mele Kadavu & chocolate
                    track.style.opacity = 0;
                    trainGroup.style.opacity = 0;
                    bridge.style.opacity = 1;
                    river.style.opacity = 1;
                    // show avatars
                    her.style.transition = 'none';
                    him.style.transition = 'none';
                    her.style.left = '28%'; him.style.right = '28%';
                    her.style.opacity = 1; him.style.opacity = 1;
                    setTimeout(() => {
                        her.style.transition = her.style.transition = 'all 1s ease';
                        him.style.transition = 'all 1s ease';
                        story.innerText = "We went to Melekadavu. The day was magical.";
                        setTimeout(() => {
                            story.innerText = "He bought me my favorite.";
                            instr.innerText = "Tap the chocolate";
                            instr.classList.add('visible');
                            choco.style.opacity = 1;
                            choco.onclick = () => {
                                choco.onclick = null;
                                instr.classList.remove('visible');
                                choco.style.top = '65%';
                                choco.style.left = '35%';
                                choco.style.transform = 'scale(0.6)';
                                choco.style.opacity = '0';
                                createParticles(window.innerWidth * 0.35, window.innerHeight * 0.65, 'üíñ');
                                stage.classList.add('closer');
                                setTimeout(() => setPhase(3), 2000);
                            };
                        }, 2500);
                    }, 200);
                }
                else if (p === 3) { // kiss
                    story.innerText = "We smiled... We talked...";
                    setTimeout(() => {
                        story.innerText = "And then, we kissed.";
                        instr.innerText = "Hold the circle to embrace";
                        instr.classList.add('visible');
                        holdBtn.style.display = 'block';
                        let filling = false;
                        const startFill = (e) => {
                            e.preventDefault();
                            if (filling) return;
                            isHolding = true;
                            filling = true;
                            let scale = 0;
                            const animate = () => {
                                if (!isHolding) { filling = false; return; }
                                scale += 0.018;
                                holdFill.style.transform = `scale(${Math.min(scale,1)})`;
                                if (scale >= 1) {
                                    isHolding = false;
                                    filling = false;
                                    createParticles(window.innerWidth/2, window.innerHeight/2, 'üíã');
                                    setPhase(4);
                                } else {
                                    requestAnimationFrame(animate);
                                }
                            };
                            requestAnimationFrame(animate);
                        };
                        const stopFill = () => { isHolding = false; holdFill.style.transform = 'scale(0)'; filling = false; };
                        holdBtn.addEventListener('mousedown', startFill);
                        holdBtn.addEventListener('touchstart', startFill, { passive: false });
                        window.addEventListener('mouseup', stopFill);
                        window.addEventListener('touchend', stopFill);
                    }, 2000);
                }
                else if (p === 4) { // commitment drag
                    holdBtn.style.display = 'none';
                    stage.classList.add('intimate');
                    createParticles(window.innerWidth/2, window.innerHeight/2, '‚ù§Ô∏è');
                    story.innerText = "From now onwards... We are for each other.";
                    setTimeout(() => {
                        story.innerText = "Forever.";
                        instr.innerText = "Drag 'Forever' to the text";
                        instr.classList.add('visible');
                        wordGame.style.display = 'flex';
                        dragWord.style.display = 'block';
                        if (!phase4DragEnabled) {
                            phase4DragEnabled = true;
                            let dragging = false;
                            const onMove = (e) => {
                                if (!dragging) return;
                                e.preventDefault();
                                const x = e.touches ? e.touches[0].clientX : e.clientX;
                                const y = e.touches ? e.touches[0].clientY : e.clientY;
                                dragWord.style.left = x + 'px';
                                dragWord.style.top = y + 'px';
                                dragWord.style.transform = 'translate(-50%, -50%)';
                            };
                            const onEnd = () => {
                                if (!dragging) return;
                                dragging = false;
                                const r1 = dragWord.getBoundingClientRect();
                                const r2 = dropZone.getBoundingClientRect();
                                if (!(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom)) {
                                    dropZone.innerText = 'Forever ‚ù§Ô∏è';
                                    dropZone.style.border = '3px solid #d4af37';
                                    dropZone.style.background = 'rgba(212,175,55,0.2)';
                                    dragWord.style.display = 'none';
                                    createParticles(window.innerWidth/2, window.innerHeight/2, '‚ú®');
                                    setTimeout(() => setPhase(5), 1500);
                                } else {
                                    dragWord.style.left = '50%';
                                    dragWord.style.top = '60%';
                                }
                                window.removeEventListener('mousemove', onMove);
                                window.removeEventListener('touchmove', onMove);
                            };
                            const onStart = (e) => {
                                e.preventDefault();
                                dragging = true;
                                window.addEventListener('mousemove', onMove);
                                window.addEventListener('touchmove', onMove, { passive: false });
                                window.addEventListener('mouseup', onEnd, { once: true });
                                window.addEventListener('touchend', onEnd, { once: true });
                            };
                            dragWord.addEventListener('mousedown', onStart);
                            dragWord.addEventListener('touchstart', onStart, { passive: false });
                        }
                    }, 2500);
                }
                else if (p === 5) {
    wordGame.style.opacity = 0;
    dragWord.style.display = 'none';
    story.innerText = "Something precious was hidden in that moment...";
    instr.innerText = '';

    setTimeout(() => {
        treasureTrigger.style.pointerEvents = 'auto';
        treasureTrigger.style.opacity = '1';

        treasureTrigger.onclick = () => {
            treasureTrigger.onclick = null; // prevent double tap
            createParticles(window.innerWidth/2, window.innerHeight*0.75, 'üíñ');
            setTimeout(() => {
                openTreasure();
            }, 500);
        };

    }, 2000);
}

                else if (p === 6) { // FINAL SCENE: together on bank, sharing chocolate
                    // hide treasure, show final positioning
                    treasureTrigger.style.opacity = '0';
                    treasureTrigger.style.pointerEvents = 'none';
                    modal.style.opacity = '0';
                    modal.style.pointerEvents = 'none';
                    stage.classList.remove('intimate', 'closer');
                    stage.classList.add('together-final');
                    // set them side by side on bank
                    her.style.left = '30%';
                    him.style.left = '52%';
                    // adjust bottom a bit (already fine)
                    story.innerText = "We share this chocolate, just like our lives‚Äîsweet and intertwined.";
                    instr.innerText = "Tap the chocolate to share";
                    instr.classList.add('visible');
                    // bring chocolate to center
                    choco.style.opacity = '1';
                    choco.style.display = 'block';
                    choco.style.left = '45%';
                    choco.style.bottom = '26vh';
                    choco.style.right = 'auto';
                    choco.style.fontSize = '4.5rem';
                    choco.style.transform = 'scale(1)';
                    choco.style.animation = 'float 2s infinite ease-in-out';
                    choco.onclick = () => {
                        if (finalChocolateShared) return;
                        finalChocolateShared = true;
                        createParticles(window.innerWidth * 0.45, window.innerHeight * 0.74, 'üç´');
                        createParticles(window.innerWidth * 0.45, window.innerHeight * 0.74, '‚ù§Ô∏è');
                        story.innerText = "We break the chocolate together. Forever sweet.";
                        instr.innerText = '';
                        choco.style.transform = 'scale(1.2)';
                        setTimeout(() => {
                            choco.style.opacity = '0.7';
                        }, 500);
                        // add floating gold hearts
                        for (let i=0;i<8;i++) {
                            setTimeout(() => createParticles(window.innerWidth*0.4 + i*20, window.innerHeight*0.7, '‚ú®'), i*100);
                        }
                    };
                }
            }

            // treasure modal functions
            window.openTreasure = function() {
                modal.style.opacity = 1;
                modal.style.pointerEvents = 'auto';
            };

            window.revealNote = function() {
                const box = document.getElementById('box');
                const note = document.getElementById('note');
                const btn = document.getElementById('together-btn');
                box.style.transform = 'scale(0)';
                setTimeout(() => {
                    box.style.display = 'none';
                    note.style.transform = 'scale(1)';
                    document.querySelectorAll('.note-line').forEach((line, i) => {
                        setTimeout(() => line.style.opacity = 1, i * 600);
                    });
                    setTimeout(() => btn.style.opacity = 1, 2800);
                }, 500);
            };

            window.startFinalTogether = function() {
                // close modal and move to phase 6
                modal.style.opacity = 0;
                modal.style.pointerEvents = 'none';
                setPhase(6);
            };

            // initial
            window.onload = () => {
                document.body.classList.add('loaded');
                createAmbientHearts();
                setTimeout(() => setPhase(1), 1000);
            };

            // extra: hide train group if needed
        })();
    </script>
</body>
</html>